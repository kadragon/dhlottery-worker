spec_id: SPEC-TELEGRAM-001
title: "Telegram Notification Service"
version: "1.0.0"
status: "draft"

description: |
  Send structured notifications to user's personal Telegram chat
  for various system events including purchase success, wins,
  errors, and low balance warnings.

given_when_then:
  - given: "A notification event occurs (purchase, error, etc.)"
    when: "Telegram notification function is called"
    then: "Message is formatted and sent to configured chat"

  - given: "Valid Telegram bot token and chat ID"
    when: "API request is made"
    then: "Message is delivered successfully"

  - given: "Notification contains structured data"
    when: "Message is formatted"
    then: "Markdown formatting is applied for readability"

  - given: "Telegram API request fails"
    when: "Network error or API error occurs"
    then: "Error is logged (do not retry infinitely)"

acceptance_tests:
  - id: TEST-TELEGRAM-001
    desc: "Should send message with correct API endpoint"
    criteria:
      - "POST to https://api.telegram.org/bot{token}/sendMessage"
      - "Request includes chat_id and text"
      - "parse_mode set to 'Markdown' or 'MarkdownV2'"

  - id: TEST-TELEGRAM-002
    desc: "Should format purchase success notification"
    criteria:
      - "Message type = 'success'"
      - "Title indicates purchase completion"
      - "Body includes: game count, cost, round number"
      - "Formatting is clear and readable"

  - id: TEST-TELEGRAM-003
    desc: "Should format low balance warning"
    criteria:
      - "Message type = 'warning'"
      - "Title indicates insufficient balance"
      - "Body includes: current balance, minimum required"
      - "Instructions for manual deposit"

  - id: TEST-TELEGRAM-004
    desc: "Should format error notification"
    criteria:
      - "Message type = 'error'"
      - "Title indicates error occurred"
      - "Body includes: error type, error message"
      - "Optional: stack trace or context (sanitized)"

  - id: TEST-TELEGRAM-005
    desc: "Should format winning notification"
    criteria:
      - "Message type = 'success'"
      - "Title indicates winning detected"
      - "Body includes: round number, rank, prize amount"

  - id: TEST-TELEGRAM-006
    desc: "Should use credentials from Secrets"
    criteria:
      - "TELEGRAM_BOT_TOKEN from env.TELEGRAM_BOT_TOKEN"
      - "TELEGRAM_CHAT_ID from env.TELEGRAM_CHAT_ID"
      - "No hardcoded tokens in code"

  - id: TEST-TELEGRAM-007
    desc: "Should handle API failures gracefully"
    criteria:
      - "Network errors are caught"
      - "API errors (4xx, 5xx) are logged"
      - "Error does not crash main execution"

dependencies:
  governance: "notification-pattern, security-patterns"
  external_services:
    - "Telegram Bot API"

linked_tasks:
  - TASK-007

implementation_notes:
  - "Use Fetch API for HTTP requests"
  - "No retry for Telegram failures (log and continue)"
  - "Sanitize all user data before including in message"
  - "Keep messages concise but informative"
  - "Consider rate limits (not critical for low-volume use)"

data_model:
  NotificationPayload:
    fields:
      - name: "type"
        type: "'success' | 'warning' | 'error'"
      - name: "title"
        type: "string"
        desc: "Brief heading for message"
      - name: "message"
        type: "string"
        desc: "Main message body"
      - name: "details"
        type: "Record<string, any>"
        optional: true
        desc: "Additional structured data"

  TelegramMessage:
    fields:
      - name: "chat_id"
        type: "string"
      - name: "text"
        type: "string"
      - name: "parse_mode"
        type: "'Markdown' | 'MarkdownV2'"

message_templates:
  purchase_success: |
    ‚úÖ **Lottery Purchase Completed**

    - Games: {gameCount}
    - Cost: {totalCost} KRW
    - Round: {roundNumber}

  low_balance: |
    ‚ö†Ô∏è **Insufficient Balance**

    - Current: {currentBalance} KRW
    - Required: {minimumBalance} KRW

    Please deposit manually.

  error: |
    ‚ùå **Error Occurred**

    - Type: {errorType}
    - Message: {errorMessage}

  winning: |
    üéâ **Winning Detected!**

    - Round: {roundNumber}
    - Rank: {rank}
    - Prize: {prizeAmount} KRW

security_requirements:
  - "Bot token from Secrets only"
  - "Never log bot token"
  - "Sanitize user data in messages"
  - "Do not include passwords or sensitive session data"

error_scenarios:
  - code: "TELEGRAM_API_ERROR"
    desc: "Telegram API returned error response"
    action: "Log error details, do not retry"

  - code: "TELEGRAM_NETWORK_ERROR"
    desc: "Cannot reach Telegram API"
    action: "Log error, do not retry"
