spec_id: SPEC-AUTH-001
title: "DHLottery User Authentication"
version: "1.0.0"
status: "draft"

description: |
  Authenticate user with DHLottery website using credentials
  stored in Cloudflare Workers Secrets.

given_when_then:
  - given: "No existing session"
    when: "Initial session cookie is requested from /common.do?method=main"
    then: "Session cookie is captured and stored"

  - given: "Valid user credentials in Workers Secrets and session cookie"
    when: "Login request is sent to /userSsl.do?method=login with proper headers"
    then: "User is authenticated and session is established"

  - given: "Invalid credentials"
    when: "Login request is sent"
    then: "Authentication error is thrown with meaningful message"

  - given: "Network failure during login"
    when: "Login request times out"
    then: "Error is caught and reported via Telegram"

  - given: "Successful login"
    when: "Checking authentication status"
    then: "User session is valid for subsequent requests"

acceptance_tests:
  - id: TEST-AUTH-001
    desc: "Should authenticate with valid credentials"
    criteria:
      - "GET request to /common.do?method=main to acquire session cookie"
      - "POST request to /userSsl.do?method=login succeeds"
      - "Response indicates successful login"
      - "Session cookies are updated"
      - "User is considered authenticated"

  - id: TEST-AUTH-002
    desc: "Should reject invalid credentials"
    criteria:
      - "Login fails with invalid credentials"
      - "AuthenticationError is thrown"
      - "Error message describes the failure"

  - id: TEST-AUTH-003
    desc: "Should use credentials from Secrets"
    criteria:
      - "USER_ID is read from env.USER_ID"
      - "PASSWORD is read from env.PASSWORD"
      - "No hardcoded credentials in code"

  - id: TEST-AUTH-004
    desc: "Should send proper login request format"
    criteria:
      - "Content-Type is application/x-www-form-urlencoded; charset=UTF-8"
      - "Request method is POST"
      - "Required form fields are included (userId, password, returnUrl, checkSave, newsEventYn)"
      - "Browser-like headers are included (User-Agent, X-Requested-With, Referer, etc.)"

dependencies:
  governance: "error-handling-pattern, security-patterns"
  specs:
    - SPEC-SESSION-001
  external_services:
    - "DHLottery login endpoint"

linked_tasks:
  - TASK-002

implementation_notes:
  - "First acquire session cookie from /common.do?method=main (GET)"
  - "Use URLSearchParams for form encoding"
  - "Include browser-like headers (User-Agent, X-Requested-With, Referer, etc.)"
  - "Send form data with: userId, password, returnUrl, checkSave=off, newsEventYn (empty)"
  - "Validate response to confirm successful login"
  - "Update session cookies after login"
  - "Handle session expiry scenarios"
  - "Parse response as JSON with fallback error handling"

security_requirements:
  - "Credentials from Workers Secrets only"
  - "Never log credentials"
  - "Mask sensitive data in error messages"
  - "Use HTTPS for all auth requests"

error_scenarios:
  - code: "AUTH_INVALID_CREDENTIALS"
    desc: "Username or password incorrect"
    action: "Throw AuthenticationError and notify via Telegram"

  - code: "AUTH_NETWORK_ERROR"
    desc: "Cannot reach login endpoint"
    action: "Retry once, then throw error"

  - code: "AUTH_UNEXPECTED_RESPONSE"
    desc: "Login response format unexpected"
    action: "Log response structure and throw error"
