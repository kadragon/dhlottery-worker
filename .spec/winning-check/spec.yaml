spec_id: SPEC-WINNING-001
title: "Lottery Winning Number Verification"
version: "1.0.0"
status: "draft"

description: |
  Check lottery winning results for the previous week period
  (Monday to Sunday) and notify if any wins are detected.

given_when_then:
  - given: "Current execution is on Monday"
    when: "Winning check is performed"
    then: "Previous week's lottery results are queried"

  - given: "User has purchased lottery in previous week"
    when: "Winning check results are received"
    then: "Results are parsed for any rank 1 or higher wins"

  - given: "Winning results contain matches"
    when: "Parsing is complete"
    then: "Telegram notification is sent with winning details"

  - given: "No winning results found"
    when: "Check is complete"
    then: "No notification is sent (silent success)"

  - given: "Winning check fails"
    when: "Network or parsing error occurs"
    then: "Error is logged but does not fail entire execution"

acceptance_tests:
  - id: TEST-WINNING-001
    desc: "Should calculate correct date range"
    criteria:
      - "Start date = previous Monday"
      - "End date = previous Sunday"
      - "Period covers exactly 7 days"

  - id: TEST-WINNING-002
    desc: "Should fetch winning results page"
    criteria:
      - "GET request to winning check endpoint"
      - "Date range parameters included"
      - "Response contains result table HTML"

  - id: TEST-WINNING-003
    desc: "Should parse winning results correctly"
    criteria:
      - "Extract lottery round numbers"
      - "Extract winning ranks (1, 2, 3, etc.)"
      - "Extract prize amounts"
      - "Parse each table row independently"

  - id: TEST-WINNING-004
    desc: "Should filter for rank 1 and higher only"
    criteria:
      - "Rank 1 wins included"
      - "Rank > 1 excluded from notifications"
      - "Empty results handled gracefully"

  - id: TEST-WINNING-005
    desc: "Should notify wins via Telegram"
    criteria:
      - "Notification type = 'success'"
      - "Message includes round number"
      - "Message includes rank"
      - "Message includes prize amount"

  - id: TEST-WINNING-006
    desc: "Should handle no-win scenario gracefully"
    criteria:
      - "Empty results array returned"
      - "No Telegram notification sent"
      - "Execution continues normally"

dependencies:
  governance: "parsing-pattern, notification-pattern"
  specs:
    - SPEC-TELEGRAM-001
  external_services:
    - "DHLottery winning results page"

linked_tasks:
  - TASK-006

implementation_notes:
  - "Use date calculations for previous week range"
  - "Parse HTML table with regex or HTMLRewriter"
  - "Only check rank 1 (as per PRD requirement)"
  - "Winning check is optional (does not block main flow)"
  - "Store HTML fixtures for various win scenarios"

data_model:
  WinningResult:
    fields:
      - name: "roundNumber"
        type: "number"
      - name: "rank"
        type: "number"
        validation: ">= 1"
      - name: "prizeAmount"
        type: "number"
        unit: "KRW"
      - name: "matchCount"
        type: "number"
        desc: "Number of matching numbers"

business_logic:
  check_period:
    start: "previous Monday 00:00 KST"
    end: "previous Sunday 23:59 KST"
    timezone: "KST (UTC+9)"

  notification_criteria:
    min_rank: 1
    max_rank: 1
    reason: "Only notify for rank 1 wins (jackpot)"

error_scenarios:
  - code: "WINNING_FETCH_FAILED"
    desc: "Cannot fetch winning results page"
    action: "Log error but do not fail execution"

  - code: "WINNING_PARSE_FAILED"
    desc: "Cannot parse results table"
    action: "Log error with HTML snippet, return empty results"

  - code: "WINNING_INVALID_DATE_RANGE"
    desc: "Date calculation produced invalid range"
    action: "Throw error (critical logic bug)"
