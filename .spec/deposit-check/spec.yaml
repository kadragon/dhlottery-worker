spec_id: SPEC-DEPOSIT-001
title: "Deposit Balance Check and Charge Initialization"
version: "1.0.0"
status: "draft"

description: |
  Check user deposit balance against minimum threshold (30,000 KRW).
  If insufficient, initialize charge page and notify user.
  If sufficient, allow lottery purchase to proceed.

given_when_then:
  - given: "Account balance is 30,000 KRW or more"
    when: "Deposit check is performed"
    then: "Purchase flow continues"

  - given: "Account balance is less than 30,000 KRW"
    when: "Deposit check is performed"
    then: "Charge page is initialized and Telegram notification is sent"

  - given: "Charge page initialization is needed"
    when: "Request is sent to /nicePay.do?method=nicePayInit"
    then: "Charge page is accessed but payment is NOT executed"

  - given: "Balance check fails due to network error"
    when: "Error occurs during check"
    then: "Error is caught and Telegram notification is sent"

acceptance_tests:
  - id: TEST-DEPOSIT-001
    desc: "Should allow purchase when balance is sufficient"
    criteria:
      - "Balance >= 30,000 KRW"
      - "Function returns true (proceed with purchase)"
      - "No charge page initialization"

  - id: TEST-DEPOSIT-002
    desc: "Should block purchase when balance is insufficient"
    criteria:
      - "Balance < 30,000 KRW"
      - "Function returns false (block purchase)"
      - "Charge page initialization is triggered"

  - id: TEST-DEPOSIT-003
    desc: "Should initialize charge page correctly"
    criteria:
      - "GET request to /nicePay.do?method=nicePayInit"
      - "Request succeeds (page accessed)"
      - "No actual payment is processed"

  - id: TEST-DEPOSIT-004
    desc: "Should notify user when balance is low"
    criteria:
      - "Telegram message sent with 'warning' type"
      - "Message includes current balance"
      - "Message requests manual deposit"

  - id: TEST-DEPOSIT-005
    desc: "Should use correct minimum threshold"
    criteria:
      - "Threshold is 30,000 KRW (from env.yaml)"
      - "Threshold is configurable constant"
      - "Comparison is exact (not approximate)"

dependencies:
  governance: "business-rules, notification-pattern"
  specs:
    - SPEC-ACCOUNT-001
    - SPEC-TELEGRAM-001
  external_services:
    - "DHLottery charge initialization endpoint"

linked_tasks:
  - TASK-004

implementation_notes:
  - "MIN_DEPOSIT_AMOUNT = 30000 (constant)"
  - "Charge page init is idempotent"
  - "No actual payment processing"
  - "Balance check happens before purchase attempt"

business_logic:
  threshold:
    value: 30000
    unit: "KRW"
    reason: "Minimum for 5-game purchase (5,000 KRW) + safety buffer"

  charge_flow:
    - "Initialize charge page (access URL)"
    - "Send Telegram notification"
    - "Stop execution (do not proceed to purchase)"
    - "User manually deposits"
    - "Next scheduled run will retry"

error_scenarios:
  - code: "DEPOSIT_CHARGE_INIT_FAILED"
    desc: "Cannot access charge page"
    action: "Log error and notify via Telegram"

  - code: "DEPOSIT_CHECK_FAILED"
    desc: "Cannot determine balance status"
    action: "Throw error (fail-safe: do not purchase)"
