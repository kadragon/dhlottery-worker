# Task Backlog
# Tasks are ordered by priority (top = highest priority)

tasks:
  # ========== Phase 1: Quick Wins (30 minutes) ==========

  - id: TASK-REFACTOR-P1-001
    title: "Remove non-functional debug HTML write code"
    spec_id: SPEC-REFACTOR-P1-DEBUG-001
    priority: medium
    phase: 1
    estimated_effort: 5min
    description: |
      Remove debug HTML write code in auth.ts (lines 171-184) that attempts to write to /tmp/.
      This code is non-functional on Cloudflare Workers (no file system access).
    files:
      - src/dhlottery/auth.ts
    test_refs:
      - TEST-REFACTOR-P1-DEBUG-001
      - TEST-REFACTOR-P1-DEBUG-002

  - id: TASK-REFACTOR-P1-002
    title: "Fix type safety for notification details field"
    spec_id: SPEC-REFACTOR-P1-TYPE-001
    priority: medium
    phase: 1
    estimated_effort: 5min
    description: |
      Change NotificationPayload.details from Record<string, any> to
      Record<string, string | number | boolean | null | undefined> to prevent
      non-serializable values and runtime JSON serialization errors.
    files:
      - src/types/notification.types.ts
    test_refs:
      - TEST-REFACTOR-P1-TYPE-001
      - TEST-REFACTOR-P1-TYPE-002
      - TEST-REFACTOR-P1-TYPE-003

  - id: TASK-REFACTOR-P1-003
    title: "Add PurchaseError class for purchase operations"
    spec_id: SPEC-REFACTOR-P1-ERROR-001
    priority: medium
    phase: 1
    estimated_effort: 10min
    description: |
      Create PurchaseError class in src/utils/errors.ts following the same pattern
      as AuthenticationError. This will be used by buy.ts and charge.ts for
      consistent error handling with specific error codes.
    files:
      - src/utils/errors.ts
    test_refs:
      - TEST-REFACTOR-P1-ERROR-001
      - TEST-REFACTOR-P1-ERROR-002
      - TEST-REFACTOR-P1-ERROR-003
      - TEST-REFACTOR-P1-ERROR-004

  - id: TASK-REFACTOR-P1-004
    title: "Document unused getAccountInfo() method in DHLotteryClient"
    spec_id: SPEC-REFACTOR-P1-DOC-001
    priority: low
    phase: 1
    estimated_effort: 5min
    description: |
      The DHLotteryClient.getAccountInfo() method is defined but never called
      (buy.ts and charge.ts call getAccountInfo() directly). Add JSDoc comment
      explaining it's intended for external API usage, or remove if truly unused.
      Recommendation: Keep with JSDoc explaining external API purpose.
    files:
      - src/dhlottery/client.ts
    test_refs:
      - TEST-REFACTOR-P1-DOC-001
      - TEST-REFACTOR-P1-DOC-002
      - TEST-REFACTOR-P1-DOC-003

  # ========== Phase 2: Refactoring (1 hour) ==========

  - id: TASK-REFACTOR-P2-001
    title: "Extract regex patterns to named constants"
    spec_id: SPEC-REFACTOR-P2-REGEX-001
    priority: medium
    phase: 2
    estimated_effort: 15min
    description: |
      Extract hardcoded regex patterns in account.ts and check.ts to named
      constant objects (BALANCE_PATTERNS, WINNING_PATTERNS) for better
      maintainability, testability, and self-documentation.
    files:
      - src/dhlottery/account.ts
      - src/dhlottery/check.ts
    test_refs:
      - TEST-REFACTOR-P2-REGEX-001
      - TEST-REFACTOR-P2-REGEX-002
      - TEST-REFACTOR-P2-REGEX-003
      - TEST-REFACTOR-P2-REGEX-004
      - TEST-REFACTOR-P2-REGEX-005

  - id: TASK-REFACTOR-P2-002
    title: "Consolidate logging under conditional DEBUG flag"
    spec_id: SPEC-REFACTOR-P2-LOG-001
    priority: medium
    phase: 2
    estimated_effort: 15min
    description: |
      Add DEBUG constant and wrap all debug/info console.log() calls with
      if (DEBUG) condition. Keep console.error() unconditional. This reduces
      production log noise and observability overhead.
    files:
      - src/constants.ts
      - src/dhlottery/auth.ts
      - src/dhlottery/account.ts
      - src/dhlottery/charge.ts
      - src/dhlottery/check.ts
    test_refs:
      - TEST-REFACTOR-P2-LOG-001
      - TEST-REFACTOR-P2-LOG-002
      - TEST-REFACTOR-P2-LOG-003
      - TEST-REFACTOR-P2-LOG-004

  - id: TASK-REFACTOR-P2-003
    title: "Update buy.ts error handling to use PurchaseError"
    spec_id: SPEC-REFACTOR-P2-ERROR-001
    priority: medium
    phase: 2
    estimated_effort: 10min
    description: |
      Replace generic Error throws in buy.ts (lines 39, 91) with PurchaseError
      class (created in TASK-REFACTOR-P1-003). Add specific error codes:
      PURCHASE_READY_FAILED, PURCHASE_EXECUTION_FAILED.
    files:
      - src/dhlottery/buy.ts
    dependencies:
      - TASK-REFACTOR-P1-003
    test_refs:
      - TEST-REFACTOR-P2-ERROR-001
      - TEST-REFACTOR-P2-ERROR-002
      - TEST-REFACTOR-P2-ERROR-003
      - TEST-REFACTOR-P2-ERROR-004

  - id: TASK-REFACTOR-P2-004
    title: "Review and document session initialization URL strategy"
    spec_id: SPEC-REFACTOR-P2-SESSION-001
    priority: low
    phase: 2
    estimated_effort: 20min
    description: |
      Investigate whether gameResult.do URL in initSession() is necessary or
      if common.do alone can establish session. Current flow uses gameResult.do
      but memory.md documents common.do. Verify against reference implementation
      and document or simplify accordingly.
    files:
      - src/dhlottery/auth.ts
    test_refs:
      - TEST-REFACTOR-P2-SESSION-001
      - TEST-REFACTOR-P2-SESSION-002
      - TEST-REFACTOR-P2-SESSION-003
      - TEST-REFACTOR-P2-SESSION-004

# ========== Summary ==========
# Phase 1: 4 tasks, ~25 minutes total
# Phase 2: 4 tasks, ~60 minutes total
# Total: 8 tasks, ~1.5 hours

# Next: Pick TASK-REFACTOR-P1-001 to start Phase 1
